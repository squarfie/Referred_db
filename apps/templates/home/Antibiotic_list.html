{% extends 'layouts/base.html' %}
{% load static %} 
{% load widget_tweaks %}

{% block title %}Add / Update Breakpoints{% endblock title %}

{% block stylesheets %}
<style>
.antibiotics-header {
  background: linear-gradient(135deg, #1a7a8e 0%, #2d9cad 50%, #45b5c6 100%);
  min-height: 180px;
  position: relative;
  overflow: hidden;
}

.antibiotics-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%), 
                    radial-gradient(circle at 80% 30%, rgba(255,255,255,0.08) 0%, transparent 50%);
  opacity: 0.6;
}

.form-card {
  border-top: 4px solid #2d9cad;
  box-shadow: 0 4px 12px rgba(29, 156, 173, 0.15);
}

.form-control-label {
  color: #1a7a8e;
  font-weight: 600;
  font-size: 0.875rem;
}

.form-control {
  border: 1px solid #d1e8ed;
  transition: all 0.3s ease;
}

.form-control:focus {
  border-color: #2d9cad;
  box-shadow: 0 0 0 0.2rem rgba(45, 156, 173, 0.15);
}

.section-divider {
  background: linear-gradient(135deg, #e8f5f7 0%, #d1e8ed 100%);
  padding: 0.75rem 1rem;
  border-radius: 0.5rem;
  margin: 1.5rem 0 1rem 0;
  border-left: 4px solid #2d9cad;
}

.checkbox-container {
  background: linear-gradient(135deg, #f8fcfd 0%, #e8f5f7 100%);
  padding: 1.5rem;
  border-radius: 0.5rem;
  border: 1px solid #d1e8ed;
}

.checkbox-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.checkbox-wrapper input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #2d9cad;
}

.btn-primary {
  background: linear-gradient(135deg, #1a7a8e 0%, #2d9cad 100%);
  border: none;
  box-shadow: 0 2px 8px rgba(29, 156, 173, 0.25);
  transition: all 0.3s ease;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #155f6f 0%, #247d8f 100%);
  box-shadow: 0 4px 12px rgba(29, 156, 173, 0.35);
  transform: translateY(-1px);
}

.btn-success {
  background: linear-gradient(135deg, #7ec97e 0%, #5fb85f 100%);
  border: none;
  box-shadow: 0 2px 8px rgba(126, 201, 126, 0.25);
}

.btn-success:hover {
  background: linear-gradient(135deg, #6ab86a 0%, #4da04d 100%);
  transform: translateY(-1px);
}

.btn-secondary {
  background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
  border: none;
}

.btn-danger {
  background: linear-gradient(135deg, #d97c7c 0%, #c24b4b 100%);
  border: none;
}

</style>
{% endblock stylesheets %}

{% block content %}
<head>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .header-container {
            position: relative;
            overflow: hidden;
            min-height: 220px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }

        /* Animated grid background */
        .grid-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            background-image: 
                linear-gradient(90deg, rgba(100, 200, 255, 0.1) 1px, transparent 1px),
                linear-gradient(rgba(100, 200, 255, 0.1) 1px, transparent 1px);
            background-size: 60px 60px;
            animation: gridMove 8s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(60px, 60px); }
        }

        /* Particle system */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(100, 200, 255, 0.6);
            border-radius: 50%;
            animation: particleFloat 15s infinite ease-in-out;
            box-shadow: 0 0 10px rgba(100, 200, 255, 0.8);
        }

        @keyframes particleFloat {
            0% { transform: translateY(100vh) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(100px); opacity: 0; }
        }

        .particle:nth-child(1) { left: 10%; animation-delay: 0s; animation-duration: 12s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 2s; animation-duration: 14s; }
        .particle:nth-child(3) { left: 30%; animation-delay: 4s; animation-duration: 16s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 1s; animation-duration: 13s; }
        .particle:nth-child(5) { left: 50%; animation-delay: 3s; animation-duration: 15s; }
        .particle:nth-child(6) { left: 60%; animation-delay: 5s; animation-duration: 17s; }
        .particle:nth-child(7) { left: 70%; animation-delay: 2.5s; animation-duration: 14.5s; }
        .particle:nth-child(8) { left: 80%; animation-delay: 4.5s; animation-duration: 16.5s; }
        .particle:nth-child(9) { left: 90%; animation-delay: 1.5s; animation-duration: 13.5s; }

        /* Circular scanning animation */
        .scanner {
            position: absolute;
            width: 400px;
            height: 400px;
            border: 2px solid rgba(100, 200, 255, 0.2);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: scan 8s linear infinite;
        }

        .scanner:nth-child(10) {
            width: 300px;
            height: 300px;
            border-color: rgba(100, 200, 255, 0.3);
            animation-delay: 1s;
            animation-duration: 10s;
        }

        .scanner:nth-child(11) {
            width: 200px;
            height: 200px;
            border-color: rgba(100, 200, 255, 0.4);
            animation-delay: 2s;
            animation-duration: 12s;
        }

        @keyframes scan {
            0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); opacity: 0; }
            25% { opacity: 1; }
            75% { opacity: 1; }
            100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); opacity: 0; }
        }

        /* Radial glow effect */
        .glow-orb {
            position: absolute;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(100, 200, 255, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(40px);
            animation: pulse 4s ease-in-out infinite;
        }

        .glow-orb:nth-child(12) {
            top: -50px;
            right: -50px;
            animation-delay: 0s;
        }

        .glow-orb:nth-child(13) {
            bottom: -50px;
            left: -50px;
            animation-delay: 2s;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        /* Overlay */
        .overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(15, 12, 41, 0.5) 0%, transparent 50%, rgba(36, 36, 62, 0.5) 100%);
            z-index: 1;
        }

        /* Header content */
        .header-content {
            position: relative;
            z-index: 2;
            flex: 1;
            color: white;
        }

        .header-content h1 {
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #64c8ff 0%, #ffffff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(100, 200, 255, 0.3);
            letter-spacing: 0.5px;
        }

        .header-content p {
            font-size: 1.2rem;
            font-weight: 300;
            color: rgba(200, 220, 255, 0.9);
            margin-bottom: 15px;
            letter-spacing: 0.5px;
        }

        .badge-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            background: rgba(100, 200, 255, 0.15);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #64c8ff;
            border: 1px solid rgba(100, 200, 255, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .badge:hover {
            background: rgba(100, 200, 255, 0.25);
            border-color: rgba(100, 200, 255, 0.6);
            box-shadow: 0 0 15px rgba(100, 200, 255, 0.3);
        }

        .badge-icon {
            margin-right: 6px;
            font-size: 1rem;
        }

        /* Right side - Stats display */
        .header-stats {
            position: relative;
            z-index: 2;
            display: flex;
            gap: 30px;
            margin-left: 60px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #64c8ff;
            text-shadow: 0 0 20px rgba(100, 200, 255, 0.5);
            display: block;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(200, 220, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Button */
        .btn-new-crf {
            position: absolute;
            top: 20px;
            right: 40px;
            z-index: 3;
            background: linear-gradient(135deg, #64c8ff 0%, #00d4ff 100%);
            color: #0f0c29;
            border: none;
            padding: 12px 32px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(100, 200, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .btn-new-crf:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(100, 200, 255, 0.6);
        }

        @media (max-width: 1024px) {
            .header-stats {
                display: none;
            }

            .header-content h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 768px) {
            .header-container {
                min-height: 180px;
                padding: 0 20px;
                flex-direction: column;
            }

            .header-content h1 {
                font-size: 1.6rem;
            }

            .header-content p {
                font-size: 0.95rem;
                margin-bottom: 10px;
            }

            .btn-new-crf {
                right: 20px;
                padding: 10px 20px;
                font-size: 0.8rem;
            }

            .badge-group {
                gap: 8px;
            }

            .badge {
                font-size: 0.75rem;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
<div class="header-container pb-6" style="min-height: 180px; position: relative;">
  <!-- Animated background elements -->
  <div class="grid-bg"></div>

  <!-- Particles rising -->
  <div class="particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
  </div>

  <!-- Scanning circles -->
  <div class="scanner"></div>
  <div class="scanner"></div>
  <div class="scanner"></div>

  <!-- Glow orbs -->
  <div class="glow-orb"></div>
  <div class="glow-orb"></div>

  <!-- Overlay -->
  <div class="overlay"></div>

  <!-- Header content wrapper with relative positioning for content -->
  <div class="container-fluid" style="position: relative; z-index: 2;">
    <div class="row align-items-center justify-content-between py-4">
      <div class="col-lg-8">
        <h6 class="h2 text-white d-inline-block mb-0">
          <i class="fas fa-flask mr-2"></i>
          {% if editing %}Edit{% else %}Add{% endif %} Antibiotics
        </h6>
        <p class="text-white mt-2 mb-0 opacity-8">
          <strong><small>Configure Antibiotic List</small></strong>
        </p>
      </div>
      <div class="col-lg-4 text-right">
        <a href="{% url 'antibiotics_view' %}" class="btn btn-sm btn-neutral">
          <i class="fas fa-table mr-1"></i>View All
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid mt--6" style="position: relative; z-index: 3;">
  <div class="card shadow form-card">
    <div class="card-body p-4">
      {% if form %}
      <form method="POST" action="{% if editing %}{% url 'edit_antibiotics' pk=form.instance.pk %}{% else %}{% url 'add_antibiotics' %}{% endif %}" id="antibioticsform">
        {% csrf_token %}
        
        <!-- Upload Button -->
        <div class="mb-4">
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#UploadModal">
            <i class="fas fa-file-upload mr-2"></i>Upload Antibiotics CSV/Excel
          </button>
        </div>

        <!-- Checkbox Section -->
        <div class="checkbox-container mb-4">
          <div class="row">
            <div class="col-md-4">
              <div class="checkbox-wrapper">
                <label class="form-control-label mb-2" for="Show">
                  <i class="fas fa-eye mr-1" style="color: #2d9cad;"></i>Show in Results
                </label>
                <input id="Show" type="checkbox" name="Show" {% if form.Show.value %}checked{% endif %} />
              </div>
            </div>
            <div class="col-md-4">
              <div class="checkbox-wrapper">
                <label class="form-control-label mb-2" for="Retest">
                  <i class="fas fa-redo mr-1" style="color: #2d9cad;"></i>Retest Required
                </label>
                <input id="Retest" type="checkbox" name="Retest" {% if form.Retest.value %}checked{% endif %} />
              </div>
            </div>
            <div class="col-md-4">
              <div class="checkbox-wrapper">
                <label class="form-control-label mb-2" for="Disk_Abx">
                  <i class="fas fa-circle mr-1" style="color: #2d9cad;"></i>Disk Diffusion Method
                </label>
                <input id="Disk_Abx" type="checkbox" name="Disk_Abx" {% if form.Disk_Abx.value %}checked{% endif %} />
              </div>
            </div>
          </div>
        </div>

        <!-- Guidelines and Test Method -->
        <div class="section-divider">
          <h5 class="mb-0" style="color: #1a7a8e;">
            <i class="fas fa-book-medical mr-2"></i>Guidelines & Methods
          </h5>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-control-label" for="Guidelines">
                <i class="fas fa-clipboard-list mr-1"></i>Guidelines
              </label>
              <select name="Guidelines" class="form-control">
                <option value="" disabled selected>Select Guidelines</option>
                {% for value, label in form.fields.Guidelines.choices %}
                <option value="{{ value }}" {% if antibiotic.Guidelines == value %}selected{% endif %}>
                  {{ label }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-control-label" for="Test_Method">
                <i class="fas fa-vial mr-1"></i>Test Method
              </label>
              <select name="Test_Method" class="form-control">
                <option value="" disabled selected>Select Test Method</option>
                {% for value, label in form.fields.Test_Method.choices %}
                <option value="{{ value }}" {% if form.Test_Method.value == value %}selected{% endif %}>
                  {{ label }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <!-- Antibiotic Information -->
        <div class="section-divider">
          <h5 class="mb-0" style="color: #1a7a8e;">
            <i class="fas fa-pills mr-2"></i>Antibiotic Information
          </h5>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-control-label" for="Antibiotic">
                <i class="fas fa-capsules mr-1"></i>Antibiotic Name
              </label>
              <input id="Antibiotic" class="form-control" value="{{antibiotic.Antibiotic}}" type="text" name="Antibiotic" placeholder="e.g. Cefixime"/>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-control-label" for="Abx_code">
                <i class="fas fa-code mr-1"></i>Antibiotic Code
              </label>
              <input id="Abx_code" class="form-control" value="{{antibiotic.Abx_code}}" type="text" name="Abx_code" placeholder="e.g. CFM"/>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-control-label" for="Potency">
                <i class="fas fa-weight mr-1"></i>Potency
              </label>
              <input id="Potency" class="form-control" value="{{antibiotic.Potency}}" type="text" name="Potency" placeholder="e.g. 30µg"/>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-control-label" for="Whonet_Abx">
                <i class="fas fa-globe mr-1"></i>WHONET Code
              </label>
              <input id="Whonet_Abx" class="form-control" value="{{antibiotic.Whonet_Abx}}" type="text" name="Whonet_Abx" placeholder="e.g. CFM_ND30"/>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-control-label" for="Tier">
                <i class="fas fa-layer-group mr-1"></i>Tier
              </label>
              <input id="Tier" class="form-control" value="{{antibiotic.Tier}}" type="text" name="Tier"/>
            </div>
          </div>
        </div>

        <!-- Classes and Subclassess -->

          <div class="row text-center">
            <div class="col-md-4">
              <label class="form-control-label" for="Class">
                <i class="fas fa-times-circle mr-1"></i>Class
              </label>
              <input id="Class" class="form-control" value="{{antiboitic.Class}}" type="text" name="Class" />
            </div>
            <div class="col-md-4">
              <label class="form-control-label" for="Subclass">
                <i class="fas fa-minus-circle mr-1"></i>Subclass
              </label>
              <input id="Subclass" class="form-control" value="{{antibiotic.Subclass}}" type="text" name="Subclass" />
            </div>
            <div class="col-md-4">
              <label class="form-control-label" for="Date_Modified">
                <i class="fas fa-check-circle mr-1"></i>Date Modified
              </label>
              <input id="Date_Modified" class="form-control" value="{{antibiotic.Date_Modified}}" type="date" name="Date_Modified" />
            </div>
          </div>

          <br>
        <!-- Action Buttons -->
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-primary btn-lg px-5">
            <i class="fas fa-save mr-2"></i>{% if editing %}Update{% else %}Add{% endif %} Antibiotics
          </button>
          <button type="button" class="btn btn-success btn-lg px-4" onclick="refresh()">
            <i class="fas fa-eraser mr-2"></i>Clear Form
          </button>
          <button type="button" class="btn btn-secondary btn-lg px-4" onclick="history.back()">
            <i class="fas fa-arrow-left mr-2"></i>Back
          </button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="UploadModal" tabindex="-1" role="dialog" aria-labelledby="UploadModalLabel" aria-hidden="true">
  <form method="POST" action="{% url 'upload_antibiotics' %}" autocomplete="on" enctype="multipart/form-data" onsubmit="return confirmOverwrite();" id="uploadbreakpointform">
    {% csrf_token %}
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content" style="border-top: 4px solid #2d9cad;">
        <div class="modal-header" style="background: linear-gradient(135deg, #e8f5f7 0%, #d1e8ed 100%); border-bottom: 2px solid #d1e8ed;">
          <h5 class="modal-title" style="color: #1a7a8e; font-weight: 600;">
            <i class="fas fa-file-upload mr-2"></i>Upload Antibiotics
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="alert" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-left: 4px solid #e6c86b; color: #856404;">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <strong>Warning:</strong> Uploading will replace all existing breakpoints.
          </div>
          <div class="form-group">
            <label for="File_uploadBP" class="form-control-label">
              <i class="fas fa-file-csv mr-1"></i>Select CSV/Excel File
            </label>
            <div>
            {{ upload_form.File_uploadAbx }}
            </div>
          </div>
        </div>
        <div class="modal-footer" style="background: #f8fcfd;">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i>Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-upload mr-1"></i>Upload File
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
function refresh() {
  if (confirm('Are you sure you want to clear all form fields?')) {
    document.getElementById("antibioticsform").reset();
  }
}

function confirmOverwrite() {
  return confirm("⚠️ WARNING: Uploading will replace all existing breakpoints. Are you sure you want to proceed?");
}
</script>

{% endblock content %}