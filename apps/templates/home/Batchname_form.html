{% extends 'layouts/base.html' %}
<!-- New table added below extends -->
<table class="table table-bordered table-hover mt-3">
  <thead class="thead-light">
    <tr>
      <th>Column 1</th>
      <th>Column 2</th>
      <th>Column 3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Row 1 Data 1</td>
      <td>Row 1 Data 2</td>
      <td>Row 1 Data 3</td>
    </tr>
    <tr>
      <td>Row 2 Data 1</td>
      <td>Row 2 Data 2</td>
      <td>Row 2 Data 3</td>
    </tr>
  </tbody>
</table>
{% load widget_tweaks %}
{% load custom_filters %}


{% block title %} Demographic Data {% endblock title %}

{% block content %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}

<!-- style for back to top button -->
<style>
#myBtn {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 30px;
  z-index: 99;
  font-size: 12px;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 10px;
  border-radius: 4px;
  height: 50px;
  
}

#myform{
  font-size: small;
}

label.form-control-label{
  font-size: small;
}

.fontsize{
  font-size: large;
  color: blue;
  font-weight: bold;
}

.fontlarge{
  font-size: large;
}
</style>
{% endblock stylesheets %}



<div class="header pb-6 d-flex align-items-center" 
     style="min-height: 200px; background-size: auto; background-image: url(/static/assets/img/theme/arsp-doh.png); background-size: cover; background-position: center top;">
  <!-- Mask -->
  <span class="mask bg-gradient-default opacity-8"></span>
  <!-- Header container -->
  <div class="container-fluid d-flex flex-column align-items-right">
    <div class="row">
      <div class="col-lg-10 col-md-4">
        <!-- <h6 class="display-2 text-white align=text-right"> 
          Hello {{ request.user.username }}
        </h6>
        <p class="text-white mt-0 mb-5"></p> --> 
        <!-- <a href="#" class="btn btn-neutral">Filter</a> -->
        <!-- <div class="row">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }}" style="background: rgba(0, 0, 0, 0); color: white; border: none;">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        </div> -->
        
        <br><br>
      </div>
    </div>
  </div>
</div>
<!-- Page content -->
<div class="container-fluid mt--6">
  <div class="row">
 
<!-- DEMOGRAPHIC DATA -->

    <div class="col-xl-12 order-xl-1">
      <form method="POST" action="{% url 'accession_data' %}" id="accession-form">
        {% csrf_token %}
        <div class="row">
        
        
          <div class="col-lg-8">
          <div class="card" >
            <div class="card-header" id="mytop">
              <div class="row align-items-center">
            <!-- <div class="col-8">
               <h3 class="mb-0">SURVEILLANCE SITE INFORMATION </h3> 
            </div> -->
            <div class="col-lg-12">
                <div class="row">
                <div class="col-lg-6">
                  <div class="form-group" >
                      <label class="form-control-label" for="SiteCode">SITE CODE</label>
                      <div class="d-flex align-items-center">
                      {{ form.SiteCode| append_attr:"class: form-control "}} 
                      <span><a href="{% url 'add_dropdown' %}" class="col-4 shortcut-item" style="padding: 0;">
                      <span class="ni ni-settings" style="margin-left: 10px; line-height: 0; vertical-align: text-bottom;"></span>
                      </a></span>
                      </div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group" >
                  <label class="form-control-label" for=" Referral_Date">Referral Date</label>
                  {{form.Referral_Date| append_attr:"class: form-control " }}
                  </div>
                </div>
              </div>
              <div class="row">
                  <div class="col-lg-6">
                  <div class="form-group" >
                  <label class="form-control-label" for="BatchNo">Batch No</label>
                  {{form.BatchNo| append_attr:"class: form-control " }}
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group" >
                  <label class="form-control-label" for="RefNo">Reference No</label>
                  {{form.RefNo| append_attr:"class: form-control " }}
                  </div>
                </div>
              </div>   
<br>          
              <div class="row">
                    <div class="col-lg-6">
                      <div class="form-group">
                        <label class='form-control-label' for='Site_Name'>Site Name</label>
                        {{form.Site_Name| append_attr:"class: form-control fontsize"}}
                      </div>
                    </div>
                      <div class="col-lg-6">
                        <div class="form-group">
                          <label class='form-control-label' for='Batch_Name'>Batch Name</label>
                          {{form.Batch_Name| append_attr:"class: form-control fontsize"}}
                        </div>
                      </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

          <div class="col-lg-4">
          <div class="card" >
        <div class="card-header" id="mytop">
          <div class="row align-items-center">
            <!-- <div class="col-8">
               <h3 class="mb-0">SURVEILLANCE SITE INFORMATION </h3> 
            </div> -->
            <div class="col-12">
            <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                      <div class="mt-4">
                      <button type="button" class="btn btn-info" id="generate-accession-btn">Generate Accession</button>
                    </div>
                </div>  
                <!-- Add this block for displaying accession number result -->
                 <div class="row">
                      <div id="accession-result" style="display:none;">
                            <table class="table">
                              <thead>
                                <tr>
                                  <th>#</th>
                                  <th>Accession No</th>
                                  <th></th>
                                </tr>
                              </thead>
                              <tbody id="accession-table-body">
                                <!-- JS fills this -->
                              </tbody>
                            </table>
                          </div>
                  {% if batch_accession_numbers %}
                    <div class="mt-12">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Accession No</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody>
                        {% for acc in batch_accession_numbers %}
                          <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ acc }}</td>
                            <td>
                              <a href="{% url 'raw_data' %}?accession={{ acc }}" class="btn btn-sm btn-info" style="display:inline-block;">Add Data</a>
                            </td>
                          </tr>
                        {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% endif %}
                  </div>
                  </div>
                  </div> 
                </div>
              </div>
              </div>
              </div>
            </div> <!--card-->
          </div>
        </div>
        </form> <!---end of form with post method-->  

       
              <!-- Page content -->
            <div class="container-fluid mt--6">
              <div class="row">
                <div class="col">
                  <div class="card">
                    <!-- Card header -->
                    <div class="card-header border-0">
                      <div class="row">
                        <div class="col md-6 d-flex justify-content-end">
                          <form id="search-input" class="navbar-search navbar-search-light form-inline mr-sm-3 " id="navbar-search-main">
                            <div class="form-group mb-0">
                              <div class="input-group input-group-alternative input-group-merge">
                                <div class="input-group-prepend">
                                  <span class="input-group-text"><i class="fas fa-search"></i></span>
                                </div>
                                <input class="form-control" placeholder="Search" type="text" onkeyup="searchTable()">
                              </div>
                            </div>
                            <button type="button" class="close" data-action="search-close" data-target="#navbar-search-main" aria-label="Close">
                              <span aria-hidden="true">x</span>
                            </button>
                            
                          </form>
                        </div>
                      </div>
                    </div>
                    <!-- Light table -->
                    <div class="table-responsive">
                      <table class="table align-items-center table-flush" style="border-collapse: collapse; margin: 0%; padding: 0%;">
                        <thead class="thead-light" style="text-align: center;">
                          <tr>
                            <th scope="col"> EDIT</th>
                            
                            <th colspan="2"  scope="col" class="sort" data-sort="Egasp_Id">Identification</th>
                            <th colspan="2" scope="col" class="sort" data-sort="Clinic">Patient Detatils</th>
                            <th colspan="2" scope="col" class="sort" data-sort="Uic_Ptid">Specimen Details</th>
                            <th scope="col">Date Encoded</th>
                            <th scope="col">Antibiotic Results</th>
                            <th> PRINT</th>
                          </tr>
                        </thead>
                        <tbody class="list">
                          {% for isolate in page_obj %}
                        <tr>
                            <td >
                            <a href="{%url 'edit_data' isolate.id %}" class="text-success"> <i class="fa fa-pencil-alt" aria-hidden="true"></i> &nbspEdit</a> <span style="display: block; line-height: 8px;"><br></span>
                            <a href="#" class="text-danger delete-btn" data-toggle="modal" data-target="#deleteModal" data-url="{% url 'delete_data' isolate.id %}">
                                  <i class="fa fa-trash" aria-hidden="true"></i> &nbspDelete</a> <span style="display: block; line-height: 8px;"><br></span>
                            
                            </td>
                            <td colspan="2">
                                Accession No: &nbsp; <strong>{{isolate.AccessionNo}}</strong><br> 
                                Referral Date: &nbsp;<strong>  {{isolate.Referral_Date}}</strong> <br>
                                Site: &nbsp; <strong> {{isolate.SiteCode}}</strong>  
                            </td>
                            <td colspan="2">Patient Name: &nbsp; <strong>{{isolate.First_Name}}</strong>&nbsp; <strong>{{isolate.Last_Name}} </strong><br>
                                Patient ID: &nbsp; <strong>{{isolate.Patient_ID}}</strong> <br>
                                Age: &nbsp; <strong>{{isolate.Age}}</strong> <br>
                                Sex: &nbsp; <strong>{{isolate.Sex}}</strong> <br>
                            </td>
                            <td colspan="2">Specimen Date: &nbsp; <strong>{{isolate.Spec_Date}}</strong><br>
                                Date of Admission: &nbsp; <strong>{{isolate.Date_Admis}}</strong> <br>
                                Specimen Num: &nbsp; <strong>{{isolate.Spec_Num}}</strong><br>
                                Specimen Type: &nbsp; <strong>{{isolate.Spec_Type}}</strong><br>
                            </td>
                            <td style="text-align: center;">{{isolate.Date_of_Entry|date:"F, d, Y" }}</td>
                            
                            <td>
                              {% for antibiotic_entry in isolate.antibiotic_entries.all %}
                                      {% if antibiotic_entry.ab_Disk_value %}
                                          <strong>{{ antibiotic_entry.ab_Antibiotic }}</strong>  
                                          (Disk: <strong>{{ antibiotic_entry.ab_Disk_value }}</strong> 
                                          <strong>{{ antibiotic_entry.ab_Disk_RIS }}</strong>)
                                          <br>
                                      {% endif %}

                                      {% if antibiotic_entry.ab_MIC_value %}
                                          <strong>{{ antibiotic_entry.ab_Antibiotic }}</strong>  
                                          (MIC: <strong>&nbsp; {{antibiotic_entry.ab_MIC_operand}} {{ antibiotic_entry.ab_MIC_value }}</strong> 
                                          <strong>{{ antibiotic_entry.ab_MIC_RIS }}</strong>)&nbsp;
                                          {% if antibiotic_entry.ab_AlertMIC %}
                                          <strong style="color: red;">Alert:</strong>&nbsp; {{ antibiotic_entry.ab_Alert_val }}
                                          {% endif %}
                                          <br>
                                      {% endif %}
                                    
                                      {% empty %}
                                      No Antibiotic Data
                                      {% endfor %}
                                      {% for retest_entry in isolate.antibiotic_entries.all %}
                                      {% if retest_entry.ab_Retest_DiskValue%}
                                          <strong>{{ retest_entry.ab_Retest_Antibiotic}}</strong>  
                                          (Retest Disk: <strong>{{ retest_entry.ab_Retest_DiskValue }}</strong> 
                                          <strong>{{retest_entry.ab_Retest_Disk_RIS }}</strong>)
                                          <br>
                                      {% endif %}
                                      {% if retest_entry.ab_Retest_MICValue %}
                                          <strong>{{ retest_entry.ab_Retest_Antibiotic}}</strong>  
                                          (Retest MIC: <strong>&nbsp; {{retest_entry.ab_Retest_MIC_operand}} {{ retest_entry.ab_Retest_MICValue }}</strong> 
                                          <strong>{{retest_entry.ab_Retest_MIC_RIS }}</strong>)&nbsp;
                                          {% if retest_entry.ab_Retest_AlertMIC %}
                                          <strong style="color: red;">Alert:</strong> &nbsp; {{retest_entry.ab_Retest_Alert_val}}
                                          {% endif %}
                                          <br>
                                      {% endif %}
                                      
                                      {% empty %}
                                      No Retest Done
                                      {% endfor %}
                                  
                            </td>
                            
                            <td>
                              <a href="{%url 'generate_pdf' isolate.id %}" class="text-info"> <i class="fa fa-print" aria-hidden="true"></i> Lab Result </a><span style="display: block; line-height: 8px;"><br></span>
                              <a href="{% url 'generate_gs' isolate.id %}"  class="text-info"> <i class="fa fa-heartbeat"></i> Gram Stain
                              </a>
                            
                            </td>
                          </tr>
                          {% endfor %}
                        
                        
                        </tbody>
                      </table>

          <!-- Add this modal HTML at the end of your template (tables.html) -->
          <form method="POST">
            {% csrf_token %}
          <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h6 class="modal-title" id="deleteModalLabel" >Delete Confirmation</h6>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                <h3 style="color: blue;"> Are you sure you want to delete this record ?</h3>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
              </div>
            </div>
          </div>

          </form>
                    </div>
                    <!-- Card footer -->
                    <div class="card-footer py-4">
                      <nav aria-label="...">
                        <ul class="pagination justify-content-center mb-0">
                        <!-- Previous Page -->
                                {% if page_obj.has_previous %}
                                <li class="page-item active">
                                  <a class="page-link" href="?page=1" tabindex="-1">
                                    <i class="fas fa-angle-double-left"></i>
                                    <span class="sr-only">First</span>
                                  </a>
                                </li>
                                <li class="page-item active">
                                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                    <i class="fas fa-angle-left"></i>
                                    <span class="sr-only">Previous</span>
                                  </a>
                                </li>
                              {% else %}
                                <li class="page-item disabled">
                                  <a class="page-link" href="#" tabindex="-1">
                                    <i class="fas fa-angle-double-left"></i>
                                    <span class="sr-only">First</span>
                                  </a>
                                </li>
                                <li class="page-item disabled">
                                  <a class="page-link" href="#" tabindex="-1">
                                    <i class="fas fa-angle-left"></i>
                                    <span class="sr-only">Previous</span>
                                  </a>
                                </li>
                              {% endif %}

                              <!-- Current Page -->
                              <!-- <li class="page-item active"> -->
                              <!-- <p>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</p> -->
                                <!-- <a class="page-link" href="#">{{ page_obj.number }}</a> -->
                              <!-- </li> -->


                              <!-- Next Page -->
                              {% if page_obj.has_next %}
                                <li class="page-item active" >
                                  <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                    <i class="fas fa-angle-right"></i>
                                    <span class="sr-only">Next</span>
                                  </a>
                                </li>
                                <li class="page-item active">
                                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">
                                    <i class="fas fa-angle-double-right"></i>
                                    <span class="sr-only">Last</span>
                                  </a>
                                </li>
                              {% else %}
                                <li class="page-item disabled">
                                  <a class="page-link" href="#">
                                    <i class="fas fa-angle-right"></i>
                                    <span class="sr-only">Next</span>
                                  </a>
                                </li>
                                <li class="page-item disabled">
                                  <a class="page-link" href="#">
                                    <i class="fas fa-angle-double-right"></i>
                                    <span class="sr-only">Last</span>
                                  </a>
                                </li>
                              {% endif %}
                          </ul>
                              <!-- Current Page -->
                              <div class="d-flex justify-content-center mb-0" style="margin-top: 15px;">
                                <div class="row ">
                                <a href="#" style="font-size: small; text-align: center;">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</a>
                                </div>
                            </div>
                      </nav>
                    </div>
                  </div>
                </div>
              </div>
            
            </div> 
            <!-- end of table -->
       


      <div class="col-12 text-left">
          <div class="col-6">
          <!-- <button class="btn btn-sm btn-primary" onclick="topFunction()" id="myBtn" title="Go to top">Go to Top</button> -->
           <!-- <a href="#mytop" class="btn btn-sm btn-primary">Back to top</a> -->
           <button type="button" onclick="topFunction()" id="myBtn" title="gototop" class="btn btn-sm btn-primary"> Back to top</button>
          </div>
        </div>

      </div>
    </div>

  </div>
 
{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}

<script>
  // Get the button (back to top button)
  let mybutton = document.getElementById("myBtn");
  
  // When the user scrolls down 50px from the top of the document, show the button
  window.onscroll = function() {scrollFunction()};
  
  function scrollFunction() {
    if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
      mybutton.style.display = "block";
    } else {
      mybutton.style.display = "none";
    }
  }
  
  // When the user clicks on the button, scroll to the top of the document
  function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }
  
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    // This will generate the Accession number
  $(document).ready(function() {
    // 1. Make sure your input/select IDs match the actual HTML element IDs.
    //    For example, use $('#id_Referral_Date') if your field's id is 'id_Referral_Date'.
    //    Check your rendered HTML for the correct IDs.

    $('#id_SiteCode').change(function() {
      const siteCode = $(this).val();
      // Fix: Use correct IDs for date, batch, ref fields
      const refDate = $('#id_Referral_Date').val();
      const batchNum = $('#id_BatchNo').val();
      const refnum = $('#id_RefNo').val();

      if (siteCode) {
        $.ajax({
          url: "{% url 'get_clinic_code' %}",
          data: { site_code: siteCode },
          dataType: 'json',
          success: function(data) {
            // Fix: Use correct SiteName field ID
            $('#id_Site_Name').val(data.site_name);
            generateAccessionNo(siteCode, refDate, batchNum, refnum);
          },
          error: function(xhr, status, error) {
            console.error("Clinic code fetch error:", status, error);
          }
        });
      } else {
        $('#id_Site_Name').val('');
        $('#id_Batch_Name').val('');
      }
    });

    $('#id_RefNo, #id_Referral_Date, #id_BatchNo').on('input change', function() {
      const refnum = $('#id_RefNo').val();
      const siteCode = $('#id_SiteCode').val();
      const refDate = $('#id_Referral_Date').val();
      const batchNum = $('#id_BatchNo').val();

      generateAccessionNo(siteCode, refDate, batchNum, refnum);
    });

    function generateAccessionNo(siteCode, refDate, batchNum, refnum) {
      if (siteCode && refDate && batchNum && refnum) {
        // Convert YYYY-MM-DD to MMDDYYYY
        const parts = refDate.split('-');
        let dateClean = '';
        if (parts.length === 3) {
          dateClean = parts[1] + parts[2] + parts[0]; // MMDDYYYY
        }
        $('#id_Batch_Name').val(siteCode + '_' + dateClean + '_' + batchNum + '_' + refnum);
      } else {
        $('#id_Batch_Name').val('');
      }
    }

    $('#id_Laboratory_Staff').change(function() {
      const labStaffId = $(this).val();
      if (labStaffId) {
        $.ajax({
          url: "{% url 'get_Lab_Staff_Details' %}",
          data: { lab_staff_id: labStaffId },
          dataType: 'json',
          success: function(data) {
            $('#id_ars_contact').val(data.LabStaff_Telnum);
            $('#id_ars_email').val(data.LabStaff_EmailAdd);
          },
          error: function(xhr, status, error) {
            console.error("Lab staff fetch error:", status, error);
          }
        });
      } else {
        $('#id_ars_contact').val('');
        $('#id_ars_email').val('');
      }
    });
  });
</script>

<script>
  document.getElementById("generate-accession-btn").addEventListener("click", function () {
    const siteCode = document.getElementById("id_SiteCode").value;
    const referralDate = document.getElementById("id_Referral_Date").value;
    const batchNo = document.getElementById("id_BatchNo").value;
    const refNo = document.getElementById("id_RefNo").value;
    const siteName = document.getElementById("id_Site_Name").value;
    const batchName = document.getElementById("id_Batch_Name").value;
    // Add other fields as needed

    const rawDataUrl = "{% url 'raw_data' %}";

    if (siteCode && referralDate && refNo) {
      fetch(`/generate-accession/?site_code=${siteCode}&referral_date=${referralDate}&ref_no=${refNo}`)
        .then(response => response.json())
        .then(data => {
          if (data.accession_numbers && Array.isArray(data.accession_numbers)) {
            const tbody = document.getElementById("accession-table-body");
            tbody.innerHTML = "";

            data.accession_numbers.forEach((acc, idx) => {
              // Build query string with all relevant data
              const params = new URLSearchParams({
                accession: acc,
                SiteCode: siteCode,
                Referral_Date: referralDate,
                BatchNo: batchNo,
                RefNo: refNo,
                Site_Name: siteName,
                Batch_Name: batchName
                // Add more fields here if needed
              }).toString();

              tbody.innerHTML += `
                <tr>
                  <td>${idx + 1}</td>
                  <td>${acc}</td>
                  <td>
                    <a href="${rawDataUrl}?${params}" class="btn btn-sm btn-info">
                      Add Details
                    </a>
                  </td>
                </tr>
              `;
            });

            document.getElementById("accession-result").style.display = "block";
          } else {
            alert(data.error || "Error generating accession number.");
          }
        })
        .catch(error => {
          console.error("Error:", error);
          alert("An unexpected error occurred.");
        });
    } else {
      alert("Please fill in Site Code, Referral Date, and Reference No.");
    }
  });
</script>


{% endblock javascripts %}



