{% extends 'layouts/base.html' %}
<!-- New table added below extends -->
{% load widget_tweaks %}
{% load custom_filters %}


{% block title %} Demographic Data {% endblock title %}

{% block content %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}

<!-- style for back to top button -->
<style>
#myBtn {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 30px;
  z-index: 99;
  font-size: 12px;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 10px;
  border-radius: 4px;
  height: 50px;
  
}

#myform{
  font-size: small;
}

label.form-control-label{
  font-size: small;
}

.fontsize{
  font-size: large;
  color: blue;
  font-weight: bold;
}

.fontlarge{
  font-size: large;
}
</style>
{% endblock stylesheets %}



<div class="header pb-6 d-flex align-items-center" 
     style="min-height: 200px; background-size: auto; background-image: url(/static/assets/img/theme/arsp-doh.png); background-size: cover; background-position: center top;">
  <!-- Mask -->
  <span class="mask bg-gradient-default opacity-8"></span>
  <!-- Header container -->
  <div class="container-fluid d-flex flex-column align-items-right">
    <div class="row">
      <div class="col-lg-10 col-md-4">
        <!-- <h6 class="display-2 text-white align=text-right"> 
          Hello {{ request.user.username }}
        </h6>
        <p class="text-white mt-0 mb-5"></p> --> 
        <!-- <a href="#" class="btn btn-neutral">Filter</a> -->
        <!-- <div class="row">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }}" style="background: rgba(0, 0, 0, 0); color: white; border: none;">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        </div> -->
        
        <br><br>
      </div>
    </div>
  </div>
</div>
<!-- Page content -->
<div class="container-fluid mt--6">
  <div class="row">
 
<!-- DEMOGRAPHIC DATA -->

    <div class="col-xl-12 order-xl-1">
      <form method="POST" action="{% url 'accession_data' %}" id="accession-form">
        {% csrf_token %}
      
        <div class="row">
        
        
          <div class="col-lg-12">
          <div class="card" >
            <div class="card-header" id="mytop">
              <div class="row align-items-center">
            <!-- <div class="col-8">
               <h3 class="mb-0">SURVEILLANCE SITE INFORMATION </h3> 
            </div> -->
            <div class="col-lg-12">
             
                <div class="row">
                <div class="col-lg-4">
                  <div class="form-group" >
                      <label class="form-control-label" for="SiteCode">SITE CODE</label>
                      <div class="d-flex align-items-center">
                      {{ form.SiteCode| append_attr:"class: form-control "}} 
                      <span><a href="{% url 'add_dropdown' %}" class="col-4 shortcut-item" style="padding: 0;">
                      <span class="ni ni-settings" style="margin-left: 10px; line-height: 0; vertical-align: text-bottom;"></span>
                      </a></span>
                      </div>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="form-group" >
                  <label class="form-control-label" for=" Referral_Date">Referral Date</label>
                  {{form.Referral_Date| append_attr:"class: form-control " }}
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="form-group" >
                  <label class="form-control-label" for="BatchNo">Batch No</label>
                  {{form.BatchNo| append_attr:"class: form-control " }}
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-4">
                  <div class="form-group" >
                  <label class="form-control-label" for="RefNo">Reference No</label>
                  {{form.RefNo| append_attr:"class: form-control " }}
                  </div>
                </div>
                    <div class="col-lg-4">
                      <div class="form-group">
                        <label class='form-control-label' for='Site_NameGen'>Site Name</label>
                        {{form.Site_NameGen| append_attr:"class: form-control fontsize"}}
                      </div>
                    </div>
                      <div class="col-lg-4">
                        <div class="form-group">
                          <label class='form-control-label' for='Batch_Name'>Batch Name</label>
                          {{form.Batch_Name| append_attr:"class: form-control fontsize"}}
                        </div>
                      </div>
                </div>
                <div class="row">
                <div class="col-lg-12">
                  <div class="form-group" style="text-align: right;">
 
                  <button type="button" class="btn btn-info" id="generate-accession-btn">Generate Accession</button>
                   </div>
                </div> 
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

          <!-- <div class="col-lg-4">
          <div class="card" >
        <div class="card-header" id="mytop">
          <div class="row align-items-center">
          
            <div class="col-12">
            <div class="row">
                <div class="col-lg-12">
                   
                
                 <div class="row"> ##  Add this block for displaying accession number result 
                      <div id="accession-result" style="display:none;">
                            <table class="table">
                              <thead>
                                <tr>
                                  <th>#</th>
                                  <th>Accession No</th>
                                  <th></th>
                                </tr>
                              </thead>
                              <tbody id="accession-table-body">
                                ##  JS fills this ##
                              </tbody>
                            </table>
                          </div>
                  {% if batch_accession_numbers %}
                    <div class="mt-12">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Accession No</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody>
                        {% for acc in batch_accession_numbers %}
                          <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ acc }}</td>
                            <td>
                              <a href="{% url 'raw_data' %}?accession={{ acc }}" class="btn btn-sm btn-info" style="display:inline-block;">Add Data</a>
                            </td>
                          </tr>
                        {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% endif %}
                 
                  </div>
                  </div>
                  </div> 
                </div>
              </div>
              </div>
              </div>
            </div> card
          </div>
        </form> -end of form with post method-->  
      </div>
    </div>

      </div>


         <div class="container-fluid">
            <div class="table-responsive">
            <table class="table align-items-center table-flush" style="border-collapse: collapse; margin: 0%; padding: 0%;">
              <thead class="thead-light" style="text-align: center;">
                <tr>
                  <th scope="col"> EDIT</th>
                  
                  <th colspan="2"  scope="col" class="sort" data-sort="Egasp_Id">Identification</th>
                  <th colspan="2" scope="col" class="sort" data-sort="Clinic">Patient Detatils</th>
                  <th colspan="2" scope="col" class="sort" data-sort="Uic_Ptid">Specimen Details</th>
                  <th scope="col">Date Encoded</th>
                  <th scope="col">Antibiotic Results</th>
                  <th> PRINT</th>
                </tr>
              </thead>
              <tbody class="list">
                {% for isolate in isolates %}
               <tr>
                  <td >
                  <a href="{%url 'edit_data' isolate.id %}" class="text-success"> <i class="fa fa-pencil-alt" aria-hidden="true"></i> &nbspEdit</a> <span style="display: block; line-height: 8px;"><br></span>
                  <a href="#" class="text-danger delete-btn" data-toggle="modal" data-target="#deleteModal" data-url="{% url 'delete_data' isolate.id %}">
                        <i class="fa fa-trash" aria-hidden="true"></i> &nbspDelete</a> <span style="display: block; line-height: 8px;"><br></span>
                  
                  </td>
                  <td colspan="2">
                      Batch: &nbsp; <strong>{{isolate.Batch_Code}}</strong> 
                      
                  </td>
                  <td colspan="2">
                      Accession No: &nbsp; <strong>{{isolate.AccessionNo}}</strong>
                     
                  </td>
                  <td colspan="2"> 
                    Referral Date: &nbsp;<strong>  {{isolate.Referral_Date}}</strong>   
                    
                  </td>
                  <td style="text-align: center;">Site: &nbsp; <strong> {{isolate.SiteCode}}</strong>  </td>
                </tr>
                {% endfor %}
               
              
              </tbody>
            </table>

              <!-- Add this modal HTML at the end of your template (tables.html) -->
              <form method="POST">
                {% csrf_token %}
              <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h6 class="modal-title" id="deleteModalLabel" >Delete Confirmation</h6>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                    <h3 style="color: blue;"> Are you sure you want to delete this record ?</h3>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                      <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                    </div>
                  </div>
                </div>
              </div>

              </form>
          </div>
        </div>


      <div class="col-12 text-left">
          <div class="col-6">
          <!-- <button class="btn btn-sm btn-primary" onclick="topFunction()" id="myBtn" title="Go to top">Go to Top</button> -->
           <!-- <a href="#mytop" class="btn btn-sm btn-primary">Back to top</a> -->
           <button type="button" onclick="topFunction()" id="myBtn" title="gototop" class="btn btn-sm btn-primary"> Back to top</button>
          </div>
        </div>

      </div>
    </div>

  </div>
 
{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}

<script>
  // Get the button (back to top button)
  let mybutton = document.getElementById("myBtn");
  
  // When the user scrolls down 50px from the top of the document, show the button
  window.onscroll = function() {scrollFunction()};
  
  function scrollFunction() {
    if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
      mybutton.style.display = "block";
    } else {
      mybutton.style.display = "none";
    }
  }
  
  // When the user clicks on the button, scroll to the top of the document
  function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }
  
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    // This will generate the Accession number
  $(document).ready(function() {
    // 1. Make sure your input/select IDs match the actual HTML element IDs.
    //    For example, use $('#id_Referral_Date') if your field's id is 'id_Referral_Date'.
    //    Check your rendered HTML for the correct IDs.

    $('#id_SiteCode').change(function() {
      const siteCode = $(this).val();
      // Fix: Use correct IDs for date, batch, ref fields
      const refDate = $('#id_Referral_Date').val();
      const batchNum = $('#id_BatchNo').val();
      const refnum = $('#id_RefNo').val();

      if (siteCode) {
        $.ajax({
          url: "{% url 'get_clinic_code' %}",
          data: { site_code: siteCode },
          dataType: 'json',
          success: function(data) {
            // Fix: Use correct SiteName field ID
            $('#id_Site_NameGen').val(data.site_name);
            generateAccessionNo(siteCode, refDate, batchNum, refnum);
          },
          error: function(xhr, status, error) {
            console.error("Clinic code fetch error:", status, error);
          }
        });
      } else {
        $('#id_Site_NameGen').val('');
        $('#id_Batch_Name').val('');
      }
    });

    $('#id_RefNo, #id_Referral_Date, #id_BatchNo').on('input change', function() {
      const refnum = $('#id_RefNo').val();
      const siteCode = $('#id_SiteCode').val();
      const refDate = $('#id_Referral_Date').val();
      const batchNum = $('#id_BatchNo').val();

      generateAccessionNo(siteCode, refDate, batchNum, refnum);
    });

    function generateAccessionNo(siteCode, refDate, batchNum, refnum) {
      if (siteCode && refDate && batchNum && refnum) {
        // Convert YYYY-MM-DD to MMDDYYYY
        const parts = refDate.split('-');
        let dateClean = '';
        if (parts.length === 3) {
          dateClean = parts[1] + parts[2] + parts[0]; // MMDDYYYY
        }
        $('#id_Batch_Name').val(siteCode + '_' + dateClean + '_' + batchNum + '_' + refnum);
      } else {
        $('#id_Batch_Name').val('');
      }
    }

    $('#id_Laboratory_Staff').change(function() {
      const labStaffId = $(this).val();
      if (labStaffId) {
        $.ajax({
          url: "{% url 'get_Lab_Staff_Details' %}",
          data: { lab_staff_id: labStaffId },
          dataType: 'json',
          success: function(data) {
            $('#id_ars_contact').val(data.LabStaff_Telnum);
            $('#id_ars_email').val(data.LabStaff_EmailAdd);
          },
          error: function(xhr, status, error) {
            console.error("Lab staff fetch error:", status, error);
          }
        });
      } else {
        $('#id_ars_contact').val('');
        $('#id_ars_email').val('');
      }
    });
  });
</script>


<script>
document.getElementById("generate-accession-btn").addEventListener("click", function (event) {
  event.preventDefault();
  const siteCode = document.getElementById("id_SiteCode").value;
  const referralDate = document.getElementById("id_Referral_Date").value;
  const batchNo = document.getElementById("id_BatchNo").value;
  const refNo = document.getElementById("id_RefNo").value;
  const siteName = document.getElementById("id_Site_NameGen").value;
  const batchName = document.getElementById("id_Batch_Name").value;

  // also store into hidden inputs so form submits them if you submit the form later
  document.getElementById("id_Site_NameGen").value = siteName;
  const batchNoHidden = document.getElementById("id_BatchNo_hidden");
  if (batchNoHidden) batchNoHidden.value = batchNo;

  if (!siteCode || !referralDate || !refNo) {
    alert("Please fill in Site Code, Referral Date, and Reference No.");
    return;
  }

  const params = new URLSearchParams({
    site_code: siteCode,
    referral_date: referralDate,
    ref_no: refNo,
    batch_no: batchNo,
    site_name: siteName,
    batch_name: batchName
  });

  fetch(`/generate-accession/?${params.toString()}`)
    .then(response => response.json())
    .then(data => {
      if (data.accession_numbers && Array.isArray(data.accession_numbers)) {
        const tbody = document.getElementById("accession-table-body");
        tbody.innerHTML = "";

        data.accession_numbers.forEach((acc, idx) => {
          const params2 = new URLSearchParams({
            accession: acc,
            SiteCode: siteCode,
            Referral_Date: referralDate,
            BatchNo: batchNo,
            RefNo: refNo,
            Site_Name: siteName,
            Batch_Name: batchName
          }).toString();

          tbody.innerHTML += `
            <tr>
              <td>${idx + 1}</td>
              <td>${acc}</td>
              <td>${siteName}</td>
              <td>
                <a href="/raw-data/?${params2}" class="btn btn-sm btn-info">Add Details</a>
              </td>
            </tr>
          `;
        });

        document.getElementById("accession-result").style.display = "block";
      } else {
        alert(data.error || "Error generating accession number.");
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("An unexpected error occurred.");
    });
});
</script>


{% endblock javascripts %}



