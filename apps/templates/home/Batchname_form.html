{% extends 'layouts/base.html' %}
<!-- New table added below extends -->
{% load widget_tweaks %}
{% load custom_filters %}


{% block title %} Demographic Data {% endblock title %}

{% block content %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}

<!-- style for back to top button -->
<style>
#myBtn {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 30px;
  z-index: 99;
  font-size: 12px;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 10px;
  border-radius: 4px;
  height: 50px;
  
}

#myform{
  font-size: small;
}

label.form-control-label{
  font-size: small;
}

.fontsize{
  font-size: large;
  color: blue;
  font-weight: bold;
}

.fontlarge{
  font-size: large;
}

table {
  margin: 0 auto;
}

.refresh-btn {
    background-color: #4CAF50; /* green */
    border: none;
    color: white;
    padding: 10px 16px;
    text-align: center;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .refresh-btn:hover {
    background-color: #45a049;
  }

</style>
{% endblock stylesheets %}



<div class="header pb-6 d-flex align-items-center" 
     style="min-height: 200px; background-size: auto; background-image: url(/static/assets/img/theme/arsp-doh.png); background-size: cover; background-position: center top; ;">
  <!-- Mask -->
  <span class="mask bg-gradient-default opacity-8"></span>
  <!-- Header container -->
  <div class="container-fluid d-flex flex-column align-items-right">
    <div class="row">
      <div class="col-lg-10 col-md-4">
        <!-- <h6 class="display-2 text-white align=text-right"> 
          Hello {{ request.user.username }}
        </h6>
        <p class="text-white mt-0 mb-5"></p> --> 
        <!-- <a href="#" class="btn btn-neutral">Filter</a> -->
        <!-- <div class="row">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }}" style="background: rgba(0, 0, 0, 0); color: white; border: none;">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        </div> -->
        
        <br><br>
      </div>
    </div>
  </div>
</div>
<!-- Page content -->
<div class="container-fluid mt--4" >
  <div class="row">
 
<!-- DEMOGRAPHIC DATA -->
 
   <!-- Container -->
<div class="container-fluid mt--6">

  <!-- Form Card -->
  <div class="card shadow border-0 mb-4">
    <div class="card-header bg-gradient-primary text-white">
      <h4 class="mb-0"><i class="ni ni-single-02 mr-2"></i> New Batch</h4>
    </div>
    <div class="card-body">
      <form method="POST" action="{% url 'accession_data' %}" id="accession-form">
        {% csrf_token %}
        
        <!-- Row 1 -->
        <div class="form-row">
          <div class="form-group col-md-3">
            <label class="form-control-label">Site Code</label>
            {{ form.SiteCode|append_attr:"class: form-control" }}
          </div>
          <div class="form-group col-md-3">
            <label class="form-control-label">Referral Date</label>
            {{ form.Referral_Date|append_attr:"class: form-control" }}
          </div>
          <div class="form-group col-md-3">
            <label class="form-control-label">Batch No</label>
            {{ form.BatchNo|append_attr:"class: form-control" }}
          </div>
          <div class="form-group col-md-3">
            <label class="form-control-label">Total Batch</label>
            {{ form.Total_batch|append_attr:"class: form-control" }}
          </div>
        </div>

        <!-- Row 2 -->
        <div class="form-row">
          <div class="form-group col-md-4">
            <label class="form-control-label">Reference No</label>
            {{ form.RefNo|append_attr:"class: form-control" }}
          </div>
          <div class="form-group col-md-4">
            <label class="form-control-label">Site Name</label>
            {{ form.Site_NameGen|append_attr:"class: form-control bg-light font-weight-bold" }}
          </div>
          <div class="form-group col-md-4">
            <label class="form-control-label">Batch Name</label>
            {{ form.Batch_Name|append_attr:"class: form-control bg-light font-weight-bold" }}
          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-between mt-2">
          <button type="button" class="btn btn-info btn-lg" id="generate-accession-btn">
            <i class="ni ni-fat-add mr-2" style="width: 30px;"></i> Generate Accession
          </button>
          <button type="button" class="btn btn-success btn-lg" onclick="refresh()">
            <i class="ni ni-ambulance mr-2" style="width: 120px;"></i>Refresh
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Accession Table -->
  <div class="card shadow">
    <div class="card-header bg-gradient-info text-white">
      <h5 class="mb-0"><i class="ni ni-collection mr-2"></i> Accession Numbers</h5>
    </div>
    <div class="card-body">
      <div id="accession-result" style="display:none;">
        <table id="accession-table" class="table table-striped table-hover text-center">
          <thead class="thead-light">
            <tr>
              <th colspan="3">#</th>
              <th colspan="3">Accession No</th>
              <th colspan="3">Site Name</th>
              <th colspan="3">Action</th>
            </tr>
          </thead>
          <tbody id="accession-table-body">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>




      <div class="col-12 text-left">
          <div class="col-6">
          <!-- <button class="btn btn-sm btn-primary" onclick="topFunction()" id="myBtn" title="Go to top">Go to Top</button> -->
           <!-- <a href="#mytop" class="btn btn-sm btn-primary">Back to top</a> -->
           <button type="button" onclick="topFunction()" id="myBtn" title="gototop" class="btn btn-sm btn-primary"> Back to top</button>
          </div>
        </div>

      </div>
    </div>

  </div>
 
{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}

<script>
  // Get the button (back to top button)
  let mybutton = document.getElementById("myBtn");
  
  // When the user scrolls down 50px from the top of the document, show the button
  window.onscroll = function() {scrollFunction()};
  
  function scrollFunction() {
    if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
      mybutton.style.display = "block";
    } else {
      mybutton.style.display = "none";
    }
  }
  
  // When the user clicks on the button, scroll to the top of the document
  function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }
  
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    // This will generate the Accession number
  $(document).ready(function() {
    // 1. Make sure your input/select IDs match the actual HTML element IDs.
    //    For example, use $('#id_Referral_Date') if your field's id is 'id_Referral_Date'.
    //    Check your rendered HTML for the correct IDs.

    $('#id_SiteCode').change(function() {
      const siteCode = $(this).val();
      // Fix: Use correct IDs for date, batch, ref fields
      const refDate = $('#id_Referral_Date').val();
      const batchNum = $('#id_BatchNo').val();
      const refnum = $('#id_RefNo').val();
      const Totalbatch= $('#id_Total_batch').val();

      if (siteCode) {
        $.ajax({
          url: "{% url 'get_clinic_code' %}",
          data: { site_code: siteCode },
          dataType: 'json',
          success: function(data) {
            // Fix: Use correct SiteName field ID
            $('#id_Site_NameGen').val(data.site_name);
            generateAccessionNo(siteCode, refDate, batchNum, refnum, Totalbatch);
          },
          error: function(xhr, status, error) {
            console.error("Clinic code fetch error:", status, error);
          }
        });
      } else {
        $('#id_Site_NameGen').val('');
        $('#id_Batch_Name').val('');
      }
    });

    $('#id_RefNo, #id_Referral_Date, #id_BatchNo, #id_Total_batch').on('input change', function() {
      const refnum = $('#id_RefNo').val();
      const siteCode = $('#id_SiteCode').val();
      const refDate = $('#id_Referral_Date').val();
      const batchNum = $('#id_BatchNo').val();
      const Totalbatch = $('#id_Total_batch').val();

      generateAccessionNo(siteCode, refDate, batchNum, refnum, Totalbatch);
    });

    function generateAccessionNo(siteCode, refDate, batchNum, refnum, Totalbatch) {
      if (siteCode && refDate && batchNum && Totalbatch && refnum) {
        // Convert YYYY-MM-DD to MMDDYYYY
        const parts = refDate.split('-');
        let dateClean = '';
        if (parts.length === 3) {
          dateClean = parts[1] + parts[2] + parts[0]; // MMDDYYYY
        }
        $('#id_Batch_Name').val(siteCode + '_' + dateClean + '_' + batchNum + '.' + Totalbatch + '_' + refnum);
      } else {
        $('#id_Batch_Name').val('');
      }
    }

    $('#id_Checked_by').change(function() {
      const labStaffId = $(this).val();
      if (labStaffId) {
        $.ajax({
          url: "{% url 'get_arsStaff_Details' %}",
          data: { lab_staff_id: labStaffId },
          dataType: 'json',
          success: function(data) {
            $('#id_ars_contact').val(data.Staff_Telnum);
            $('#id_ars_email').val(data.Staff_EmailAdd);
          },
          error: function(xhr, status, error) {
            console.error("Lab staff fetch error:", status, error);
          }
        });
      } else {
        $('#id_ars_contact').val('');
        $('#id_ars_email').val('');
      }
    });
  });
</script>


<script>
function renderAccessions(data, siteCode, referralDate, batchNo, refNo, siteName, batchName, totalBatch) {
  const tbody = document.getElementById("accession-table-body");
  const table = document.getElementById("accession-table"); // your existing table
  tbody.innerHTML = "";

  data.accession_numbers.forEach((acc, idx) => {
    const params2 = new URLSearchParams({
      accession: acc,
      SiteCode: siteCode,
      Referral_Date: referralDate,
      BatchNo: batchNo,
      RefNo: refNo,
      Site_Name: siteName,
      Batch_Name: batchName,
      Total_batch: totalBatch
    }).toString();
    
    tbody.innerHTML += `
    
      <tr>
       
        <td></td> 
        <td>${idx + 1}</td>
        <td></td> 
        <td></td> 
        <td>${acc}</td>
        <td></td> 
        <td></td> 
        <td>${siteName}</td>
        <td></td> 
        <td></td> 
        <td>
          <a href="/raw-data/?${params2}" class="btn btn-sm btn-info">Add Details</a>
        </td>
        <td></td> 
      </tr>
    `;
  });
 
  // Center the table
  table.style.textAlign = "center";
  table.style.marginLeft = "auto";
  table.style.marginRight = "auto";



  // block makes the table visible only when generated
  document.getElementById("accession-result").style.display = "block";
}



// Generated accessions are retained until generate accession button is clicked
document.getElementById("generate-accession-btn").addEventListener("click", function (event) {
  event.preventDefault();
  const siteCode = document.getElementById("id_SiteCode").value;
  const referralDate = document.getElementById("id_Referral_Date").value;
  const batchNo = document.getElementById("id_BatchNo").value;
  const totalBatch = document.getElementById("id_Total_batch").value;
  const refNo = document.getElementById("id_RefNo").value;
  const siteName = document.getElementById("id_Site_NameGen").value;
  const batchName = document.getElementById("id_Batch_Name").value;

  if (!siteCode || !referralDate || !refNo) {
    alert("Please fill in Site Code, Referral Date, and Reference No.");
    return;
  }

  const params = new URLSearchParams({
    site_code: siteCode,
    referral_date: referralDate,
    ref_no: refNo,
    batch_no: batchNo,
    site_name: siteName,
    batch_name: batchName,
    total_batch: totalBatch
  });

  fetch(`/generate-accession/?${params.toString()}`)
    .then(response => response.json())
    .then(data => {
      if (data.accession_numbers && Array.isArray(data.accession_numbers)) {
        // Save to localStorage
        localStorage.setItem("accession_data", JSON.stringify({
          accession_numbers: data.accession_numbers,
          siteCode, referralDate, batchNo, refNo, siteName, batchName, totalBatch
        }));

        // Render the table
        renderAccessions(data, siteCode, referralDate, batchNo, refNo, siteName, batchName, totalBatch);
      } else {
        alert(data.error || "Error generating accession number.");
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("An unexpected error occurred.");
    });
});

// On page load, restore saved data
window.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("accession_data");
  if (saved) {
    const parsed = JSON.parse(saved);
    renderAccessions(parsed, parsed.siteCode, parsed.referralDate, parsed.batchNo, parsed.refNo, parsed.siteName, parsed.batchName, parsed.totalBatch);
  }
});
</script>


<!-- refresh button -->

<script>
  function refresh() {
    document.getElementById('id_SiteCode').value = '';
    document.getElementById('id_Referral_Date').value = '';
    document.getElementById('id_BatchNo').value = '';
    document.getElementById('id_Total_batch').value = '';
    document.getElementById('id_RefNo').value = '';
  }
</script>








{% endblock javascripts %}



