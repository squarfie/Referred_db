{% extends 'layouts/base.html' %}
{% block title %}WGS Data Overview{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="header bg-primary pb-6" style="min-height: 200px; background-image: url(/static/assets/img/theme/microbial.jpg); background-size: cover; background-position: bottom center;">
  <span class="mask bg-gradient-default opacity-3"></span>
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col-lg-6 col-7">
          <h6 class="h2 text-white d-inline-block mb-0">Referred Isolates Database</h6>
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
              <li class="breadcrumb-item"><a href="{% url 'home' %}"><i class="fas fa-home"></i></a></li>
              <li class="breadcrumb-item active" aria-current="page">WGS Data Overview</li>
            </ol>
          </nav>
        </div>
        <div class="col-lg-6 col-5 text-right">
          <a class="btn btn-sm btn-neutral" href="{% url 'batch_create_view' %}">New Batch</a>
          <a class="btn btn-sm btn-neutral" href="{% url 'upload_wgs_view' %}">Upload Data</a>
          <button class="btn btn-sm btn-warning" data-toggle="modal" data-target="#downloadModal">Download WGS Data</button>
          <button class="btn btn-sm btn-neutral" onclick="history.back()">Back</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid mt--6">
  <div class="card shadow">
    <div class="card-header bg-gradient-primary border-0">
      <div class="row align-items-center">
        <div class="col">
          <h3 class="mb-0 text-white"><i class="ni ni-atom mr-2"></i>WGS Data Overview</h3>
        </div>
        <div class="col text-right">
          <span class="text-white counter-text">
            Loaded <strong style="color: #201cf0;">{{ table_data|length }} Accession(s)</strong> with sequencing data. 
          </span>
        </div>
      </div>
    </div>
    
    <div class="card-body">
      <!-- Filter Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex align-items-center justify-content-between flex-wrap">
            <h5 class="mb-0"><i class="ni ni-ui-04 mr-2"></i>Filter by Data Type:</h5>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-sm btn-outline-success filter-btn" data-filter="fastq">
                <i class="ni ni-cloud-upload-96 mr-1"></i>FastQ
              </button>
              <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="gambit">
                <i class="ni ni-chart-bar-32 mr-1"></i>Gambit
              </button>
              <button class="btn btn-sm btn-outline-warning filter-btn" data-filter="mlst">
                <i class="ni ni-atom mr-1"></i>MLST
              </button>
              <button class="btn btn-sm btn-outline-info filter-btn" data-filter="checkm2">
                <i class="ni ni-check-bold mr-1"></i>CheckM2
              </button>
              <button class="btn btn-sm btn-outline-danger filter-btn" data-filter="assembly">
                <i class="ni ni-settings mr-1"></i>Assembly
              </button>
              <button class="btn btn-sm btn-outline-purple filter-btn" data-filter="amrfinder">
                <i class="ni ni-lock-circle-open mr-1"></i>AMRFinder
              </button>
              <button class="btn btn-sm btn-secondary" id="clear-filter">
                <i class="ni ni-fat-remove mr-1"></i>Clear Filter
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="table-responsive" style="max-height: 550px; overflow-y: auto;">
        <table class="table table-hover table-flush align-middle mb-0" id="wgs-table">
          <thead class="thead-light sticky-top">
            <tr class="text-center">
              <th class="text-left">Accession No</th>
              <th><i class="ni ni-cloud-upload-96 text-success"></i> FastQ</th>
              <th><i class="ni ni-chart-bar-32 text-primary"></i> Gambit</th>
              <th><i class="ni ni-atom text-warning"></i> MLST</th>
              <th><i class="ni ni-check-bold text-info"></i> CheckM2</th>
              <th><i class="ni ni-settings text-danger"></i> Assembly</th>
              <th><i class="ni ni-lock-circle-open text-purple"></i> AMRFinder</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in table_data%}
            <tr class="text-center data-row"
                data-fastq="{{ entry.summary_flags.fastq|yesno:'true,false' }}"
                data-gambit="{{ entry.summary_flags.gambit|yesno:'true,false' }}"
                data-mlst="{{ entry.summary_flags.mlst|yesno:'true,false' }}"
                data-checkm2="{{ entry.summary_flags.checkm2|yesno:'true,false' }}"
                data-assembly="{{ entry.summary_flags.assembly|yesno:'true,false' }}"
                data-amrfinder="{{ entry.summary_flags.amrfinder|yesno:'true,false' }}">
              <td class="text-left"><strong class="text-primary">{{ entry.accession }}</strong></td>
              <td>{% if entry.summary_flags.fastq %}<span class="badge badge-success">✓</span>{% else %}<span class="badge badge-light">—</span>{% endif %}</td>
              <td>{% if entry.summary_flags.gambit %}<span class="badge badge-success">✓</span>{% else %}<span class="badge badge-light">—</span>{% endif %}</td>
              <td>{% if entry.summary_flags.mlst %}<span class="badge badge-success">✓</span>{% else %}<span class="badge badge-light">—</span>{% endif %}</td>
              <td>{% if entry.summary_flags.checkm2 %}<span class="badge badge-success">✓</span>{% else %}<span class="badge badge-light">—</span>{% endif %}</td>
              <td>{% if entry.summary_flags.assembly %}<span class="badge badge-success">✓</span>{% else %}<span class="badge badge-light">—</span>{% endif %}</td>
              <td>{% if entry.summary_flags.amrfinder %}<span class="badge badge-success">✓</span>{% else %}<span class="badge badge-light">—</span>{% endif %}</td>
              <td>
                <button class="btn btn-sm btn-primary toggle-view-btn" type="button" data-accession="{{ entry.accession }}">
                  <i class="ni ni-zoom-split-in"></i> <span class="btn-text">View</span>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Download Modal -->
      <div class="modal fade" id="downloadModal" tabindex="-1" role="dialog" aria-labelledby="downloadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-gradient-primary text-white">
              <h5 class="modal-title" id="downloadModalLabel">Download WGS Data</h5>
              <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p class="text-muted mb-3">Choose which type of WGS data you want to download:</p>
              <ul>
                <li><strong>Complete Sets:</strong> Found in <em>all</em> WGS tables</li>
                <li><strong>Partial Sets:</strong> Found in <em>any</em> WGS table</li>
              </ul>
            </div>
            <div class="modal-footer justify-content-between">
                <a href="{% url 'download_matched_wgs_data' %}?mode=all" class="btn btn-primary">
                  <i class="ni ni-check-bold"></i> Complete Sets
                </a>
                <a href="{% url 'download_matched_wgs_data' %}?mode=any" class="btn btn-success">
                  <i class="ni ni-cloud-download-95"></i> Partial Sets
                </a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
/* Color utilities */
.text-purple {
  color: #8965e0;
}

.text-warning {
  color: #fbc658;
}

/* Badge styles */
.badge-light {
  background-color: #e9ecef;
  color: #6c757d;
}

.btn-outline-purple {
  color: #8965e0;
  border-color: #8965e0;
}

.btn-outline-purple:hover {
  background-color: #8965e0;
  border-color: #8965e0;
  color: white;
}

/* Filter button active states */
.filter-btn.active {
  background-color: var(--btn-bg);
  color: white;
  border-color: var(--btn-bg);
}

.filter-btn[data-filter="fastq"].active {
  --btn-bg: #2dce89;
}

.filter-btn[data-filter="gambit"].active {
  --btn-bg: #5e72e4;
}

.filter-btn[data-filter="mlst"].active {
  --btn-bg: #fb6340;
}

.filter-btn[data-filter="checkm2"].active {
  --btn-bg: #11cdef;
}

.filter-btn[data-filter="assembly"].active {
  --btn-bg: #f5365c;
}

.filter-btn[data-filter="amrfinder"].active {
  --btn-bg: #8965e0;
  border-color: #8965e0;
}

/* Utilities */
.gap-2 {
  gap: 0.5rem;
}

.sticky-top {
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 10;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterButtons = document.querySelectorAll('.filter-btn');
  const clearButton = document.getElementById('clear-filter');
  const dataRows = document.querySelectorAll('.data-row');
  const counterText = document.querySelector('.counter-text');
  let activeFilter = null;

  function applyFilter(filterType) {
    dataRows.forEach(row => {
      const hasData = row.dataset[filterType] === 'true';
      row.style.display = hasData ? '' : 'none';
    });
    updateCounter();
  }

  function showAllRows() {
    dataRows.forEach(row => row.style.display = '');
    updateCounter();
  }

  function updateCounter() {
    const visibleCount = Array.from(dataRows).filter(r => r.style.display !== 'none').length;
    if (counterText) {
      const label = activeFilter ? `with ${activeFilter.toUpperCase()}` : 'in Total';
      counterText.innerHTML = `<strong>${visibleCount}</strong> Accession(s) ${label}`;
    }
  }

  filterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const filterType = this.dataset.filter;
      
      if (activeFilter === filterType) {
        activeFilter = null;
        btn.classList.remove('active');
        showAllRows();
      } else {
        filterButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeFilter = filterType;
        applyFilter(filterType);
      }
    });
  });

  clearButton.addEventListener('click', function() {
    activeFilter = null;
    filterButtons.forEach(b => b.classList.remove('active'));
    showAllRows();
  });

  // Toggle view button functionality
  const toggleButtons = document.querySelectorAll('.toggle-view-btn');

  toggleButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      const accession = this.dataset.accession;
      const parentRow = this.closest('tr');
      const existingRow = document.querySelector(`#details-${accession}`);
      const icon = this.querySelector('i');
      const text = this.querySelector('.btn-text');

      // If details already shown → remove (toggle off)
      if (existingRow) {
        existingRow.remove();
        icon.className = 'ni ni-zoom-split-in';
        text.textContent = 'View';
        this.classList.remove('btn-secondary');
        this.classList.add('btn-primary');
        return;
      }

      // Create new placeholder row
      const newRow = document.createElement('tr');
      newRow.id = `details-${accession}`;
      newRow.innerHTML = `
        <td colspan="8" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </td>`;
      parentRow.insertAdjacentElement('afterend', newRow);

      // Change button to "Hide" state
      icon.className = 'ni ni-zoom-split-out';
      text.textContent = 'Hide';
      this.classList.remove('btn-primary');
      this.classList.add('btn-secondary');

      // Fetch WGS details dynamically
      fetch(`/wgs/get-details/${accession}/`)
        .then(res => res.json())
        .then(data => {
          if (data.html) {
            newRow.innerHTML = `<td colspan="8">${data.html}</td>`;
          } else {
            newRow.innerHTML = `<td colspan="8" class="text-center text-danger">Failed to load details.</td>`;
          }
        })
        .catch(err => {
          console.error(err);
          newRow.innerHTML = `<td colspan="8" class="text-center text-danger">Error loading details.</td>`;
          // Revert button on error
          icon.className = 'ni ni-zoom-split-in';
          text.textContent = 'View';
          this.classList.remove('btn-secondary');
          this.classList.add('btn-primary');
        });
    });
  });
});
</script>

{% endblock %}